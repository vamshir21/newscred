<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsCred+ Full Analyzer</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding:0; background-color: #eef2f7; color: #333; line-height: 1.7; font-size: 16px;}
        .header { background-color: #007bff; color: white; padding: 20px 0; text-align: center; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300;}
        .container { max-width: 900px; margin: 20px auto; background-color: #fff; padding: 25px 35px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.12); }
        label { font-weight: 600; margin-right: 8px; color: #555; }
        .input-options { margin-bottom: 20px; display: flex; align-items: center; gap: 20px; }
        .input-options input[type="radio"] { margin-right: 5px; transform: scale(1.1); }
        textarea, input[type="url"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; box-sizing: border-box; transition: border-color 0.3s; }
        textarea:focus, input[type="url"]:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        input[type="submit"] { background-color: #28a745; color: white; padding: 12px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 1.15em; display: block; width: 100%; transition: background-color 0.3s; }
        input[type="submit"]:hover { background-color: #218838; }
        .results-area { margin-top: 30px; }
        .result-section { margin-bottom: 25px; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; background-color: #fdfdfd; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .result-section h2 { margin-top: 0; font-size: 1.6em; color: #0056b3; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 15px; }
        .result-section h3 { font-size: 1.2em; color: #333; margin-top:15px; margin-bottom:8px;}
        .result-section p, .result-section li { margin-bottom: 8px; color: #444; }
        .result-section strong { color: #000; }
        .real-news-pred { color: #155724; font-weight: bold; }
        .fake-news-pred { color: #721c24; font-weight: bold; }
        .error-message-box { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 6px; text-align: center; margin-bottom: 20px;}
        .flash-messages { list-style-type: none; padding: 0; margin-bottom: 20px; }
        .flash-messages li { padding: 10px 15px; border-radius: 4px; margin-bottom: 10px; font-weight: 500; }
        .flash-messages .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash-messages .danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .flash-messages .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .flash-messages .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .sentiment-positive { color: #28a745; font-weight: bold;}
        .sentiment-negative { color: #dc3545; font-weight: bold;}
        .sentiment-neutral { color: #007bff; font-weight: bold;}
        .image-display img { max-width:200px; max-height:150px; border:1px solid #ddd; margin:10px 0; border-radius: 4px; display: block; }
        .corroboration-list, .image-match-list { list-style-type: none; padding-left: 0; }
        .corroboration-list li, .image-match-list li { background-color:#f9f9f9; border:1px solid #eee; padding:10px; margin-bottom:8px; border-radius:4px;}
        .corroboration-list a, .image-match-list a { color: #0056b3; text-decoration: none; font-weight: 500;}
        .corroboration-list a:hover, .image-match-list a:hover { text-decoration: underline; }
        .corroboration-list p small, .image-match-list p small { color: #555; display: block; margin-top: 4px;}
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .source-info { text-align:center; margin-top:25px; font-style: italic; color: #6c757d; }
        .feedback-section button, .feedback-section select { padding: 8px 12px; margin: 5px; border-radius:4px; border:1px solid #ccc; cursor:pointer; font-size: 0.9em;}
        .feedback-section button[name="feedback_type"][value="correction"] { background-color:#ffc107; color:#212529;}
        .feedback-section button[name="feedback_type"][value="accurate"] { background-color:#28a745; color:white;}
        .fact-check-item { border-left: 4px solid #ffc107; padding-left: 10px; background-color: #fff9e6 !important; }
        .reputable-source-item { border-left: 4px solid #28a745; padding-left: 10px; background-color: #e6ffe6 !important; }
        .debunk-flag-section { color: #721c24; font-weight: bold; margin-top: 15px; padding:10px; background-color: #f8d7da; border-radius: 4px; border: 1px solid #f5c6cb;}
        .debunk-flag-section ul { list-style-position: inside; padding-left: 5px;}
    </style>
</head>
<body>
    <div class="header">
        <h1>NewsCred+ Comprehensive Analyzer</h1>
    </div>
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <form method="POST" id="newsForm" action="{{ url_for('index') }}"> {# CORRECTED #}
            <div class="input-options">
                <input type="radio" id="inputTypeText" name="input_type" value="text" {% if input_type == 'text' or not input_type %}checked{% endif %}>
                <label for="inputTypeText">Paste Text</label>
                <input type="radio" id="inputTypeUrl" name="input_type" value="url" {% if input_type == 'url' %}checked{% endif %}>
                <label for="inputTypeUrl">Enter Article URL</label>
            </div>

            <div id="textEntry" class="input-field-group">
                <textarea name="news_text" rows="12" placeholder="Paste full news article text here...">{{ news_text_value }}</textarea>
            </div>
            <div id="urlEntry" class="input-field-group" style="display:none;">
                <input type="url" name="news_url" placeholder="e.g., https://www.example.com/news/article-title" value="{{ news_url_value }}">
            </div>
            
            <input type="submit" value="Analyze Article">
        </form>

        <div id="loader" class="loader"></div>

        {% if analysis_done %}
            <div class="results-area">
                {% if error_message %}
                    <div class="error-message-box">
                        <p>{{ error_message }}</p>
                    </div>
                {% else %}
                    <!-- Credibility Prediction -->
                    <div class="result-section">
                        <h2>Core Credibility Prediction</h2>
                        {% if prediction_text %}
                            <p><span class="{{ 'real-news-pred' if prediction_label == 0 else 'fake-news-pred' }}">{{ prediction_text }}</span>
                                {% if confidence_score %}(Confidence: {{ confidence_score }}%){% endif %}</p>
                        {% else %}
                            <p>Could not determine credibility prediction for the provided text.</p>
                        {% endif %}
                    </div>

                    <!-- Source Credibility -->
                    {% if source_credibility %}
                    <div class="result-section">
                        <h2>Source Credibility Analysis</h2>
                        <p><strong>Source Domain:</strong> {{ source_credibility.domain }}</p>
                        <p><strong>Assessed Credibility:</strong> <span style="font-weight:bold;">{{ source_credibility.rating }}</span> (Score: {{ source_credibility.score_str }}/100)</p>
                        {% if source_credibility.bias and source_credibility.bias != "N/A" %}<p><strong>Reported Bias:</strong> {{ source_credibility.bias }}</p>{% endif %}
                        {% if source_credibility.factual_reporting and source_credibility.factual_reporting != "N/A" %}<p><strong>Reported Factual Reporting:</strong> {{ source_credibility.factual_reporting }}</p>{% endif %}
                        <p><small><em>Notes: {{ source_credibility.notes }}</em></small></p>
                    </div>
                    {% endif %}

                    <!-- Article Summary -->
                    {% if article_summary %}
                    <div class="result-section">
                        <h2>Article Summary</h2>
                        <p>{{ article_summary }}</p>
                    </div>
                    {% endif %}

                    <!-- Sentiment Analysis -->
                    {% if sentiment_label %}
                    <div class="result-section">
                        <h2>Sentiment Analysis</h2>
                        <p>Overall Sentiment: 
                            <span class="{% if sentiment_label == 'Positive' %}sentiment-positive{% elif sentiment_label == 'Negative' %}sentiment-negative{% else %}sentiment-neutral{% endif %}">
                                {{ sentiment_label }}
                            </span>
                            {% if sentiment_score %}(Score: {{ sentiment_score }}){% endif %}
                        </p>
                    </div>
                    {% endif %}

                    <!-- Enhanced Web Corroboration -->
                    {% if corroboration_data and (corroboration_data.query_used != 'N/A' or corroboration_data.error) %}
                    <div class="result-section">
                        <h2>Web Corroboration & Context</h2>
                        {% if corroboration_data.error %}
                            <p><i>{{ corroboration_data.error }}</i></p>
                        {% else %}
                            <p><small><em>Search query used: "{{ corroboration_data.query_used|truncate(70) }}"</em></small></p>
                            
                            {% if corroboration_data.debunking_flags %}
                                <div class="debunk-flag-section">
                                    <p><strong>Potential Debunking Indicators Found:</strong></p>
                                    <ul>
                                        {% for flag in corroboration_data.debunking_flags %}
                                            <li><small>{{ flag }}</small></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}

                            {% if corroboration_data.fact_checks %}
                                <h3>Fact-Checking Sites:</h3>
                                <ul class="corroboration-list">
                                {% for item in corroboration_data.fact_checks %}
                                    <li class="fact-check-item">
                                        <a href="{{ item.link }}" target="_blank"><strong>{{ item.title|truncate(100) }}</strong></a>
                                        {% if item.snippet %}<p><small>{{ item.snippet|truncate(250) }}</small></p>{% endif %}
                                    </li>
                                {% endfor %}
                                </ul>
                            {% endif %}

                            {% if corroboration_data.reputable_sources %}
                                <h3>Mentions from Reputable News Sources:</h3>
                                <ul class="corroboration-list">
                                {% for item in corroboration_data.reputable_sources %}
                                    <li class="reputable-source-item">
                                        <a href="{{ item.link }}" target="_blank"><strong>{{ item.title|truncate(100) }}</strong></a>
                                        {% if item.snippet %}<p><small>{{ item.snippet|truncate(250) }}</small></p>{% endif %}
                                    </li>
                                {% endfor %}
                                </ul>
                            {% endif %}
                            
                            {% if corroboration_data.general_results %}
                                <h3>Other Web Mentions:</h3>
                                <ul class="corroboration-list">
                                {% for item in corroboration_data.general_results %}
                                    <li>
                                        <a href="{{ item.link }}" target="_blank"><strong>{{ item.title|truncate(100) }}</strong></a>
                                        {% if item.snippet %}<p><small>{{ item.snippet|truncate(250) }}</small></p>{% endif %}
                                    </li>
                                {% endfor %}
                                </ul>
                            {% endif %}
                            {% if not corroboration_data.fact_checks and not corroboration_data.reputable_sources and not corroboration_data.general_results and not corroboration_data.debunking_flags %}
                                <p>No specific corroborating web results or debunking flags found for the query.</p>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Image Analysis -->
                    {% if top_image_url or (all_image_urls and all_image_urls|length > 0) or image_analysis_results %}
                    <div class="result-section">
                        <h2>Image Analysis</h2>
                        {% if image_analysis_results %}
                            {% for image_result in image_analysis_results %}
                                <div class="image-display" style="margin-bottom:20px;">
                                    <h3>Image Found: <a href="{{ image_result.original_url }}" target="_blank" style="font-size:0.8em; word-break:break-all;">{{ image_result.original_url.split('/')[-1]|truncate(40) }}</a></h3>
                                    <img src="{{ image_result.original_url }}" alt="Analyzed Image">
                                    {% if image_result.error %}
                                        <p><small><i>{{ image_result.error }}</i></small></p>
                                    {% else %}
                                        {% if image_result.web_entities %}
                                            <p><strong>Possibly related to:</strong> {{ image_result.web_entities|join('; ') }}</p>
                                        {% endif %}
                                        {% if image_result.full_matching_images %}
                                            <p><strong>Exact matches found (Top {{image_result.full_matching_images|length}}):</strong></p>
                                            <ul class="image-match-list">{% for m_url in image_result.full_matching_images %}<li><a href="{{ m_url }}" target="_blank">{{ m_url|truncate(70) }}</a></li>{% endfor %}</ul>
                                        {% endif %}
                                        {% if image_result.pages_with_matching_images %}
                                            <p><strong>Pages with this image (Top {{image_result.pages_with_matching_images|length}}):</strong></p>
                                            <ul class="image-match-list">{% for page in image_result.pages_with_matching_images %}<li><a href="{{ page.url }}" target="_blank">{{ page.title|truncate(70) if page.title else page.url|truncate(70) }}</a></li>{% endfor %}</ul>
                                        {% endif %}
                                        {% if not image_result.web_entities and not image_result.full_matching_images and not image_result.pages_with_matching_images %}
                                            <p><small><i>No specific web intelligence found for this image via API.</i></small></p>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% elif top_image_url %} 
                            <div class="image-display">
                                <h3>Top Image from Article:</h3>
                                <img src="{{ top_image_url }}" alt="Top Image from Article">
                                <p><small><i>Detailed reverse image search not performed (e.g. API not configured or called).</i></small></p>
                            </div>
                        {% endif %}

                        {% if all_image_urls and all_image_urls|length > (1 if top_image_url else 0) %}
                            <h3>Other Images Found in Article ({{ all_image_urls|length }}):</h3>
                            <ul class="image-match-list" style="max-height: 100px; overflow-y:auto;">
                            {% for img_url in all_image_urls %}
                                {% if img_url != top_image_url %}
                                    <li><a href="{{ img_url }}" target="_blank">{{ img_url|truncate(80) }}</a></li>
                                {% endif %}
                            {% endfor %}
                            </ul>
                        {% endif %}
                        
                        {% if not top_image_url and (not all_image_urls or all_image_urls|length == 0) and not image_analysis_results %}
                            <p>No significant images found in the article for analysis.</p>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Feedback Section -->
                    {% if prediction_text and prediction_label != -1 %}
                    <div class="result-section feedback-section" style="margin-top: 20px; text-align:center; background-color: #f0f0f0;">
                        <h3>Was this prediction helpful/correct?</h3>
                        <form method="POST" action="{{ url_for('submit_feedback') }}"> {# CORRECTED #}
                            <input type="hidden" name="analyzed_input_value" value="{{ news_url_value if input_type == 'url' else news_text_value|truncate(5000) }}"> {# Truncate long pasted text #}
                            <input type="hidden" name="predicted_label_internal" value="{{ prediction_label }}">
                            <input type="hidden" name="original_input_type" value="{{ input_type }}">
                            <input type="hidden" name="original_news_text" value="{{ news_text_value|truncate(5000) }}"> {# Truncate for hidden field #}
                            <input type="hidden" name="original_news_url" value="{{ news_url_value }}">

                            <p>Our model predicted: <strong>{{ prediction_text.replace("Prediction: ", "") }}</strong></p>
                            <p>If this is incorrect, please help us improve:</p>
                            <select name="user_corrected_label">
                                <option value="">-- Select Correct Label (if different) --</option>
                                <option value="0">REAL News</option>
                                <option value="1">FAKE News</option>
                            </select>
                            <button type="submit" name="feedback_type" value="correction">Submit Correction</button>
                            <br><br>
                            <button type="submit" name="feedback_type" value="accurate">Prediction was Accurate</button>
                        </form>
                    </div>
                    {% endif %}

                    <p class="source-info"><small>Source Analyzed: {{ article_source_url if article_source_url else 'Pasted Text' }}</small></p>
                {% endif %} {# End of no error_message #}
            </div> {# End of results-area #}
        {% endif %} {# End of analysis_done #}
    </div>

    <script>
        const form = document.getElementById('newsForm');
        const textEntryDiv = document.getElementById('textEntry');
        const urlEntryDiv = document.getElementById('urlEntry');
        const inputTypeText = document.getElementById('inputTypeText');
        const inputTypeUrl = document.getElementById('inputTypeUrl');

        function toggleInputFields() {
            if (inputTypeText.checked) {
                textEntryDiv.style.display = 'block';
                urlEntryDiv.style.display = 'none';
            } else {
                textEntryDiv.style.display = 'none';
                urlEntryDiv.style.display = 'block';
            }
        }
        inputTypeText.addEventListener('change', toggleInputFields);
        inputTypeUrl.addEventListener('change', toggleInputFields);
        if(form) { 
            form.addEventListener('submit', function() { 
                const loader = document.getElementById('loader');
                if(loader) loader.style.display = 'block'; 
            });
        }
        window.addEventListener('DOMContentLoaded', (event) => { toggleInputFields(); });
    </script>
</body>
</html>